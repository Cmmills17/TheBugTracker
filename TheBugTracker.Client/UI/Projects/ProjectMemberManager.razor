@inject ICompanyDTOService CompanyService
@inject ISnackbar Snackbar

@if (Project is not null)
{
    <AuthorizeView Roles="@($"{Role.Admin}, {Role.ProjectManager}")">
       
        <div class="vstack gap-3">
            
            <div >

                <MudText Typo="Typo.h6" GutterBottom>Developers</MudText>

                <MudChipSet @bind-SelectedValues="selectedDeveloperIds"
                            SelectionMode="SelectionMode.MultiSelection">

                    @foreach (UserDTO developer in developers)
                    {
                        <UserChip User="developer" />
                    }
                </MudChipSet>
                

            </div>


            <div >
                <MudText Typo="Typo.h6" GutterBottom>Submitters</MudText>
                <MudChipSet @bind-SelectedValues="selectedSubmitterIds"
                            SelectionMode="SelectionMode.MultiSelection">

                    @foreach (UserDTO submitter in submitters)
                    {
                        <UserChip User="submitter" />
                    }
                        
                </MudChipSet>

            </div>


            <div class="text-end">

                <MudButton Variant="Variant.Text"
                            Color="Color.Error"
                            StartIcon="@Icons.Material.Filled.Cancel"
                            OnClick="HandleCancel">
                    Cancel
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="HandleSave">
                    Save
                </MudButton>

            </div>

        </div>

    </AuthorizeView>
}



@code {
    [Parameter, EditorRequired]
    public ProjectDTO? Project { get; set; }

    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private UserInfo? userInfo;

    private IEnumerable<UserDTO> developers = [];
    private IEnumerable<UserDTO> submitters = [];

    private IReadOnlyCollection<string> selectedDeveloperIds = [];
    private IReadOnlyCollection<string> selectedSubmitterIds = [];

    protected override async Task OnParametersSetAsync()
    {
        userInfo ??= await UserInfoHelper.GetUserInfoAsync(AuthStateTask);

        try
        {
            developers = await CompanyService.GetUsersInRoleAsync(Role.Developer, userInfo!);
            submitters = await CompanyService.GetUsersInRoleAsync(Role.Submitter, userInfo!);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Failed to load users", Severity.Error);
        }
    }

    private void HandleCancel()
    {
        selectedDeveloperIds = [];
        selectedSubmitterIds = [];
    }

    private async Task HandleSave()
    {
        try
        {
            // TODO: actually save these changes
            Console.WriteLine($"developers: {string.Join(",", selectedDeveloperIds)}");
            Console.WriteLine($"submitters: {string.Join(",", selectedSubmitterIds)}");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Failed to save changes", Severity.Error);
        }
    }

}